---
import Header from "~/components/Header.astro";
import BasePage from "~/layouts/BasePage.astro";

import IssueList from "~/components/IssueList/IssueList.astro";
import IssueCard from "~/components/IssueList/IssueCard.astro";
import IssueEyebrow from "~/components/IssueList/IssueEyebrow.astro";
import IssueTitle from "~/components/IssueList/IssueTitle.astro";

import formatDate from "~/utils/formatDate";

import { getCollection, getEntry } from "astro:content";

// Get slug from path
const { slug } = Astro.params;

if (!slug) {
  throw new Error("Slug is required");
}

// Get entry from collection
const entry = await getEntry("newsletter", slug);

if (!entry) {
  return Astro.redirect("/404");
}

// Get the last three issues, excluding the current issue
const newsletterIssues = await getCollection("newsletter");
const lastIssues = newsletterIssues
  .filter((entry) => entry.slug !== slug)
  .slice(-3)
  .reverse();

// Render the markdown content
const { Content } = await entry.render();
---

<BasePage
  slug={entry.slug}
  title={`${entry.data.title} - DEPTÂ® Node Zebra`}
  description={entry.data.tagline}
  date={entry.data.date}
>
  <Header>
    <p class="text-sm mb-2 text-light">{entry.data.title.toUpperCase()}</p>
    <h1 class="text-3xl max-w-xl">{entry.data.tagline}</h1>
    <div class="flex gap-12 mt-12">
      <div>
        <p class="text-light text-base">Read time</p>
        <p>{entry.data.length} minutes</p>
      </div>
      <div>
        <p class="text-light text-base">Date</p>
        <p>{formatDate(entry.data.date)}</p>
      </div>
    </div>
  </Header>

  <div class="mx-auto max-w-3xl py-8 px-4 sm:px-6 lg:px-16">
    <Content />
  </div>

  <div class="flex flex-col md:flex-row">
    <div class="text-white bg-onyx grow px-4 sm:px-6 lg:px-16 py-24">
      <p class="text-5xl">Read more</p>
    </div>
    <div class="py-14 md:py-6 px-4 sm:px-6 lg:px-16 max-w-3xl mx-auto">
      <IssueList>
        {
          lastIssues.map((issue) => (
            <IssueCard title={issue.data.tagline} variant="sm">
              <IssueEyebrow>
                <span>{issue.data.title.toUpperCase()}</span>
                <span>â€¢</span>
                <span>23 September 2023</span>
              </IssueEyebrow>

              <IssueTitle to={`/newsletter/${issue.slug}`}>
                {issue.data.tagline}
              </IssueTitle>
            </IssueCard>
          ))
        }
      </IssueList>
    </div>
  </div>
</BasePage>
